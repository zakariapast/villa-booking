<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Villas</title>
  <link rel="stylesheet" href="/public/css/admin.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <style>
    .villa-card img {
      max-height: 220px;
      object-fit: cover;
      border-radius: 0.375rem;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>All Villas</h2>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="previewPublic()">
          üëÅ View as Customer
        </button>
        <button class="btn btn-success" onclick="openAddModal()">
          + Add Villa
        </button>
      </div>
    </div>

    <div id="villaList" class="row g-4"></div>
  </div>

  <!-- Add/Edit Modal Template -->
  <div class="modal fade" id="villaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="villaModalTitle">Add Villa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="villaForm" enctype="multipart/form-data">
            <input type="hidden" id="villaId" />
            <div class="mb-3">
              <label for="name" class="form-label">Villa Name</label>
              <input type="text" class="form-control" id="name" required />
            </div>
            <div class="mb-3">
              <label for="location" class="form-label">Location (Text)</label>
              <input type="text" class="form-control" id="location" required />
            </div>
            <div class="mb-3">
              <label for="map" class="form-label">Google Maps Link</label>
              <input type="url" class="form-control" id="map" />
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="image" class="form-label">Upload Image</label>
              <input class="form-control" type="file" id="image" accept="image/*">
              <div class="form-text">Recommended: 1200x800px, max 1MB</div>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="visible">
              <label class="form-check-label" for="visible">Visible to Public</label>
            </div>
            <div class="text-end">
              <button type="submit" class="btn btn-primary">Save Villa</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap & Logic -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let editingVillaId = null;
    const modal = new bootstrap.Modal(document.getElementById('villaModal'));

    async function loadVillas() {
      const res = await fetch('/api/villas');
      const villas = await res.json();
      const list = document.getElementById('villaList');
      list.innerHTML = '';

      villas.forEach(villa => {
        const col = document.createElement('div');
        col.className = 'col-md-6';
        col.innerHTML = `
          <div class="card villa-card">
            <img src="${villa.image}" class="card-img-top" alt="${villa.name}" />
            <div class="card-body">
              <h5 class="card-title">${villa.name}</h5>
              <p class="card-text"><small class="text-muted">${villa.location}</small></p>
              <p class="card-text">${villa.description.substring(0, 120)}...</p>
              <div class="d-flex gap-2 flex-wrap">
                <a href="/admin/rooms/list?villa=${villa.id}" class="btn btn-primary btn-sm">View Rooms</a>
                <button onclick="editVilla('${villa.id}')" class="btn btn-warning btn-sm">Edit</button>
                <button onclick="deleteVilla('${villa.id}')" class="btn btn-danger btn-sm">Delete</button>
                <button class="btn btn-sm ${villa.visible ? 'btn-outline-success' : 'btn-outline-secondary'}">
                  ${villa.visible ? 'Visible to Public' : 'Hidden from Public'}
                </button>
              </div>
            </div>
          </div>`;
        list.appendChild(col);
      });
    }

    function openAddModal() {
      document.getElementById('villaModalTitle').innerText = 'Add Villa';
      document.getElementById('villaForm').reset();
      document.getElementById('villaId').value = '';
      modal.show();
    }

    async function editVilla(id) {
      const res = await fetch('/api/villas');
      const villas = await res.json();
      const v = villas.find(v => v.id === id);
      if (!v) return alert('Villa not found');
      document.getElementById('villaId').value = v.id;
      document.getElementById('name').value = v.name;
      document.getElementById('location').value = v.location;
      document.getElementById('map').value = v.map;
      document.getElementById('description').value = v.description;
      document.getElementById('visible').checked = v.visible;
      document.getElementById('villaModalTitle').innerText = 'Edit Villa';
      modal.show();
    }

    async function deleteVilla(id) {
      if (!confirm('Delete this villa?')) return;
      await fetch(`/api/villas/${id}`, { method: 'DELETE' });
      loadVillas();
    }

    document.getElementById('villaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('villaId').value;
      const data = new FormData();
      data.append('name', document.getElementById('name').value);
      data.append('location', document.getElementById('location').value);
      data.append('map', document.getElementById('map').value);
      data.append('description', document.getElementById('description').value);
      data.append('visible', document.getElementById('visible').checked);
      const file = document.getElementById('image').files[0];
      if (file) data.append('image', file);

      const method = id ? 'PUT' : 'POST';
      const url = id ? `/api/villas/${id}` : '/api/villas';

      await fetch(url, { method, body: data });
      modal.hide();
      loadVillas();
      e.target.reset();
    });

    function previewPublic() {
      window.open('/public-home.html', '_blank');
    }

    loadVillas();
  </script>
</body>
</html>
