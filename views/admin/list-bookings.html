<!-- views/admin/list-bookings.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Bookings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      padding: 20px;
      font-family: 'Poppins', sans-serif;
      background-color: #f4f6f9;
    }
    h2 {
      margin-bottom: 20px;
    }
    table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    thead {
      background-color: #2E8B57;
      color: white;
    }
    .status-badge {
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
    }
    .pending { background: #f0ad4e; color: white; }
    .confirmed { background: #5cb85c; color: white; }
  </style>
</head>
<body>
<h2>Booking List</h2><ul class="nav nav-tabs mb-3" id="statusTabs">
  <li class="nav-item">
    <a class="nav-link active" data-status="">All</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-status="pending">Pending</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-status="confirmed">Confirmed</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-status="cancelled">Cancelled</a>
  </li>
</ul>
<input type="text" id="searchInput" class="form-control mb-3" placeholder="Search by guest, email, or villa..." />
  <button class="btn btn-success mb-3" onclick="exportToExcel()">Export to Excel</button>
    <table class="table table-bordered" id="bookingTable">
      <thead>
        <tr>
          <th>Villa</th>
          <th>Room</th>
          <th>Guest</th>
          <th>Email</th>
          <th>Dates</th>
          <th>Guests</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="bookingList"></tbody>
    </table>
  </div>

<script>
  let allBookings = [];

  async function loadBookings() {
    try {
      const res = await fetch('/api/bookings');
      allBookings = await res.json();
      renderBookings(allBookings);
    } catch (err) {
      console.error('Failed to load bookings:', err);
    }
  }

  function renderBookings(bookings) {
    const tbody = document.getElementById('bookingList');
    tbody.innerHTML = '';

    bookings.forEach(b => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.setAttribute('data-bs-toggle', 'modal');
      tr.setAttribute('data-bs-target', '#bookingModal');
      tr.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') return; // ignore if clicked button
      showBookingDetail(b);
      });
      tr.innerHTML = `
        <td>${b.villaName}</td>
        <td>${b.roomName || '-'}</td>
        <td>${b.name}</td>
        <td>${b.email}</td>
        <td>${b.checkin?.slice(0,10)} â†’ ${b.checkout?.slice(0,10)}</td>
        <td>${b.guestDetail || b.guests}</td>
        <td>
          <span class="status-badge ${b.status}">${b.status}</span><br/>
          <button class="btn btn-sm btn-success me-1" onclick="updateStatus('${b.id}', 'confirmed')">Confirm</button>
          <button class="btn btn-sm btn-danger" onclick="updateStatus('${b.id}', 'cancelled')">Cancel</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
function showBookingDetail(b) {
  const body = document.getElementById('bookingDetailBody');
  body.innerHTML = `
    <p><strong>Villa:</strong> ${b.villaName}</p>
    <p><strong>Room:</strong> ${b.roomName || '-'}</p>
    <p><strong>Guest Name:</strong> ${b.name}</p>
    <p><strong>Email:</strong> ${b.email}</p>
    <p><strong>Check-in:</strong> ${b.checkin?.slice(0, 10)}</p>
    <p><strong>Check-out:</strong> ${b.checkout?.slice(0, 10)}</p>
    <p><strong>Guest Breakdown:</strong> ${b.guestDetail || b.guests}</p>
    <p><strong>Status:</strong> <span class="status-badge ${b.status}">${b.status}</span></p>
    <p><strong>Special Requests:</strong><br/>${b.notes || '-'}</p>
  `;
}

let selectedStatus = '';

function applyFilters() {
  const term = document.getElementById('searchInput').value.toLowerCase();

  const filtered = allBookings.filter(b => {
    const matchesSearch =
      (b.name || '').toLowerCase().includes(term) ||
      (b.email || '').toLowerCase().includes(term) ||
      (b.villaName || '').toLowerCase().includes(term);

    const matchesStatus = selectedStatus === '' || b.status === selectedStatus;
    return matchesSearch && matchesStatus;
  });

  renderBookings(filtered);
}

  document.getElementById('searchInput').addEventListener('input', applyFilters);
 // document.getElementById('statusFilter').addEventListener('change', applyFilters);
  loadBookings();
  document.querySelectorAll('#statusTabs .nav-link').forEach(tab => {
  tab.addEventListener('click', function () {
    document.querySelectorAll('#statusTabs .nav-link').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    selectedStatus = this.getAttribute('data-status');
    applyFilters();
  });
});

  async function updateStatus(id, newStatus) {
    if (!confirm(`Are you sure to set status to ${newStatus}?`)) return;

    try {
      const res = await fetch(`/api/bookings/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (res.ok) {
        alert("Status updated");
        await loadBookings();
      applyFilters(); // maintain filter after reload
      } else {
        alert("Failed to update status");
      }
    } catch (err) {
      console.error("Status update error:", err);
      alert("Error occurred");
    }
  }
  function exportToExcel() {
  const exportData = allBookings.map(b => ({
    'Villa': b.villaName,
    'Room': b.roomName || '-',
    'Guest Name': b.name,
    'Email': b.email,
    'Check-in': b.checkin?.slice(0,10),
    'Check-out': b.checkout?.slice(0,10),
    'Guests': b.guestDetail || b.guests,
    'Status': b.status,
    'Special Requests': b.notes || '-',
    'Created At': new Date(b.createdAt).toLocaleString()
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Bookings');
  XLSX.writeFile(workbook, 'villa-bookings.xlsx');
}

</script>
<!-- Booking Detail Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Booking Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="bookingDetailBody">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Working SheetJS CDN (public/free version) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


</body>
</html>
